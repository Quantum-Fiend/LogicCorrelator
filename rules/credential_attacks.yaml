# Credential Attack Detection Rules

rules:
  - name: "Credential Stuffing Attack"
    id: "CRED-001"
    description: "Multiple failed login attempts followed by successful authentication"
    severity: HIGH
    enabled: true
    mitre_techniques:
      - T1110.001  # Brute Force: Password Guessing
      - T1110.004  # Brute Force: Credential Stuffing
    
    conditions:
      - type: auth_fail
        count: ">= 5"
        window: 120
        group_by: ["user"]
      
      - type: auth_success
        same_user: true
        within: 30
        after_previous: true
    
    actions:
      - alert:
          message: "Possible credential stuffing attack detected"
          severity: HIGH
          confidence: 0.85
      - tag:
          - "credential_attack"
          - "brute_force"
      - export_graph: true

  - name: "Password Spray Attack"
    id: "CRED-002"
    description: "Single password attempted across multiple accounts"
    severity: HIGH
    enabled: true
    mitre_techniques:
      - T1110.003  # Brute Force: Password Spraying
    
    conditions:
      - type: auth_fail
        count: ">= 10"
        window: 300
        unique_users: ">= 5"
        same_source_ip: true
    
    actions:
      - alert:
          message: "Password spray attack detected"
          severity: HIGH
          confidence: 0.90
      - tag:
          - "credential_attack"
          - "password_spray"
      - export_graph: true

  - name: "Credential Compromise Chain"
    id: "CRED-003"
    description: "Failed logins followed by PowerShell execution and external connection"
    severity: CRITICAL
    enabled: true
    mitre_techniques:
      - T1110  # Brute Force
      - T1059.001  # PowerShell
      - T1071  # Application Layer Protocol
    
    conditions:
      - type: auth_fail
        count: ">= 3"
        window: 60
        group_by: ["user"]
      
      - type: process_start
        process_name: "powershell.exe"
        same_user: true
        within: 120
        after_previous: true
      
      - type: network_connect
        direction: "outbound"
        dest_port: [443, 80, 8080]
        within: 60
        after_previous: true
    
    actions:
      - alert:
          message: "Possible credential compromise with command execution"
          severity: CRITICAL
          confidence: 0.95
      - tag:
          - "credential_attack"
          - "command_execution"
          - "exfiltration"
      - export_graph: true

  - name: "Suspicious Login After Hours"
    id: "CRED-004"
    description: "Successful authentication during non-business hours"
    severity: MEDIUM
    enabled: true
    mitre_techniques:
      - T1078  # Valid Accounts
    
    conditions:
      - type: auth_success
        time_range:
          start: "22:00"
          end: "06:00"
        exclude_users: ["admin", "monitoring"]
    
    actions:
      - alert:
          message: "After-hours authentication detected"
          severity: MEDIUM
          confidence: 0.70
      - tag:
          - "anomalous_login"
          - "after_hours"

  - name: "Impossible Travel"
    id: "CRED-005"
    description: "User authentication from geographically distant locations in short time"
    severity: HIGH
    enabled: true
    mitre_techniques:
      - T1078  # Valid Accounts
    
    conditions:
      - type: auth_success
        count: ">= 2"
        window: 3600
        same_user: true
        different_source_ip: true
        geo_distance: "> 500km"  # Requires GeoIP lookup
    
    actions:
      - alert:
          message: "Impossible travel detected for user"
          severity: HIGH
          confidence: 0.88
      - tag:
          - "credential_attack"
          - "impossible_travel"
      - export_graph: true
